import path from 'path';
import { cp, readdir, readFile, writeFile, lstat } from 'fs/promises';
import { existsSync } from 'fs';
import formatFilename from './format-filename.js';
import addFrontMatter from './add-front-matter.js';
import transformLinks from './transform-links.js';
import createDir from './create-dir.js';
import { fileURLToPath } from 'url';
const __dirname = path.dirname(fileURLToPath(import.meta.url));

/**
 * transformFile - Transform the content of a file
 * @param {string} content The content of the file
 * @param {string} filename The name of the file
 * @returns {object} The transformed content
 */
function transformFile(content, filename) {
  content = transformLinks(content);
  const { transformedContent, file } = addFrontMatter(content, filename);
  return { content: transformedContent, filename: file };
}

/**
 * copyCreateGasketApp - Copy the create-gasket-app README to the site docs
 * @param {string} projectRoot The root of the project
 */
async function copyCreateGasketApp(projectRoot) {
  const sourceFile = path.join(projectRoot, 'packages', 'create-gasket-app', 'README.md');
  const { content, filename } = transformFile(await readFile(sourceFile, 'utf8'), 'create-gasket-app.md');
  const targetFile = path.join(projectRoot, 'site', 'docs', filename);
  await writeFile(targetFile, content, 'utf8');
}

/**
 * copyMissingExamples - Copy EXAMPLES.md files that weren't generated by Gasket docs
 * @param {string} projectRoot The root of the project
 * @param {string} targetRoot The root of the target docs
 */
async function copyMissingExamples(projectRoot, targetRoot) {
  const packagesDir = path.join(projectRoot, 'packages');
  const packageDirs = await readdir(packagesDir, { withFileTypes: true });

  for (const dirent of packageDirs) {
    if (!dirent.isDirectory()) continue;

    const packagePath = path.join(packagesDir, dirent.name);
    const examplesPath = path.join(packagePath, 'EXAMPLES.md');

    // Check if EXAMPLES.md exists in source but not in target
    if (existsSync(examplesPath)) {
      let targetDir;
      let packageName;

      try {
        const packageJson = JSON.parse(await readFile(path.join(packagePath, 'package.json'), 'utf-8'));
        packageName = packageJson.name.replace('@gasket/', '');

        if (dirent.name.startsWith('gasket-plugin-')) {
          targetDir = path.join(targetRoot, 'plugins', packageName);
        } else if (dirent.name.startsWith('gasket-preset-')) {
          targetDir = path.join(targetRoot, 'presets', packageName);
        } else {
          targetDir = path.join(targetRoot, 'modules', packageName);
        }

        const targetExamplesPath = path.join(targetDir, 'EXAMPLES.md');

        // Only copy if it doesn't already exist
        if (!existsSync(targetExamplesPath)) {
          const { content: transformedContent } = transformFile(
            await readFile(examplesPath, 'utf-8'),
            'EXAMPLES.md'
          );
          await writeFile(targetExamplesPath, transformedContent, 'utf8');
        }
      } catch {
        // Ignore packages without valid package.json
        continue;
      }
    }
  }
}

/**
 * copyPackageDocs - Copy the package docs to the site docs
 * @param {string} sourceRoot The root of the source docs
 * @param {string} targetRoot The root of the target docs
 */
async function copyPackageDocs(sourceRoot, targetRoot) {
  const dirs = ['modules', 'plugins', 'presets'];
  const excludedPath = '@gasket';

  for (const dir of dirs) {
    await createDir(targetRoot, dir);
    await cp(
      path.join(sourceRoot, dir, excludedPath),
      path.join(targetRoot, dir),
      {
        recursive: true,
        filter: (src) => !src.includes('LICENSE.md')
      }
    );
    // Create an index file for each folder
    await writeFile(
      path.join(targetRoot, dir, `${formatFilename(dir)}.mdx`),
      `import DocCardList from '@theme/DocCardList';\n\n<DocCardList />`,
      'utf8'
    );
  }
}

/**
 * copyRootDocs - Copy the root docs to the site docs
 * @param {string} projectRoot The root of the project
 * @param {string} targetRoot The root of the target docs
 */
async function copyRootDocs(projectRoot, targetRoot) {
  const rootDocs = await readdir(path.join(projectRoot, 'docs'));
  // Copy the root docs folder
  for (const file of rootDocs) {
    const stats = await lstat(path.join(projectRoot, 'docs', file));
    if (!stats.isDirectory()) {
      const { content: fileContent, filename } = transformFile(
        await readFile(path.join(projectRoot, 'docs', file), 'utf-8'),
        file
      );
      await writeFile(path.join(targetRoot, filename), fileContent, 'utf8');
    } else if (stats.isDirectory()) {
      await createDir(targetRoot, file);
      await cp(
        path.join(projectRoot, 'docs', file),
        path.join(targetRoot, file),
        { recursive: true }
      );
    }
  }

  // Copy the README, CONTRIBUTING, SECURITY, and LICENSE files
  const { content: readme, filename: readmeFilename } = transformFile(
    await readFile(path.join(projectRoot, 'README.md'), 'utf-8'),
    'README.md'
  );
  await writeFile(path.join(targetRoot, readmeFilename), readme, 'utf8');

  const { content: contributing, filename: contributingFilename } = transformFile(
    await readFile(path.join(projectRoot, 'CONTRIBUTING.md'), 'utf-8'),
    'CONTRIBUTING.md'
  );
  await writeFile(path.join(targetRoot, contributingFilename), contributing, 'utf8');

  const { content: security, filename: securityFilename } = transformFile(
    await readFile(path.join(projectRoot, 'SECURITY.md'), 'utf-8'),
    'SECURITY.md'
  );
  await writeFile(path.join(targetRoot, securityFilename), security, 'utf8');

  const { content: license, filename: licensenFilename } = transformFile(
    await readFile(path.join(projectRoot, 'LICENSE.md'), 'utf-8'),
    'LICENSE.md'
  );
  await writeFile(path.join(targetRoot, licensenFilename), license, 'utf8');
}

/**
 * copySiteDocs - Copy the site docs to the site docs
 * @param {string} projectRoot The root of the project
 */
export default async function copySiteDocs(projectRoot) {
  const sourceRoot = path.join(__dirname, '..', '.docs', 'docs');
  const targetRoot = path.join(projectRoot, 'site', 'docs');
  await copyPackageDocs(sourceRoot, targetRoot);
  await copyCreateGasketApp(projectRoot);
  await copyRootDocs(projectRoot, targetRoot);
  await copyMissingExamples(projectRoot, targetRoot);
}
